<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<head>

  <!-- 라이브러리 -->
  <script src="js/fabric.min.js"></script>
  <script src="js/jquery-3.5.1.min.js"></script>
  <script src="js/FileSaver.min.js"></script>
  <script src="js/canvas-toBlob.js"></script>
  <script src="js/vanilla-picker.min.js"></script>

  <style>
    @import url(http://fonts.googleapis.com/earlyaccess/notosanskr.css);

    body {
      font-family: "Noto Sans KR", sans-serif;
      margin: 0px;        
    }

    /* 메뉴 */
    .navbar {
      overflow: hidden;
      /* height: 38px; */
      color: #CCCCCC;
      background-color: #333333;
      border-bottom: #1E1E1E;
      align-items: center;
    }
    
    .navbar a {
      float: left;
      font-size: 16px;
      color: white;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
      align-items: center;
    }

    .navbar .saperator {
      /* display:inline; */
      list-style: none;
      padding: 5px 0px 5px 5px;
      margin-bottom: 5px;      
      border-bottom: 1px solid #c0c0c0;
    }

    .dropdown {
      float: left;
      overflow: hidden;
    }

    .dropdown .dropbtn {
      font-size: 16px;  
      border: none;
      outline: none;
      color: white;
      padding: 14px 16px;
      background-color: inherit;
      font-family: inherit;
      margin: 0;
    }  

    .navbar a:hover, .dropdown:hover .dropbtn {
      background-color: red;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #333333;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
    }

    .dropdown-content a {
      float: none;
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      text-align: left;
    }

    .dropdown-content a:hover {
      background-color: red;
    }

    .dropdown:hover .dropdown-content {
      display: block;
    }

    #mind_area {

    }

</style>
</head>

		<!-- 문자열 -->
		<!-- 컬러가이드 -->
    <!-- 저장 -->

<body>
  <div class="navbar">
    <a href="">SMUD</a>
    <div class="dropdown">
      <button class="dropbtn">
        <img src="https://img.icons8.com/fluent-systems-filled/24/ffffff/menu.png"/>
        <!-- <img src="https://img.icons8.com/fluent-systems-filled/12/ffffff/sort-down.png"/> -->
      </button>
      <div class="dropdown-content">
        <a href="#"><img src="https://img.icons8.com/fluent-systems-filled/24/ffffff/file.png"/></a>
        <li class="saperator"></li>
        <a href=""><img src="https://img.icons8.com/fluent-systems-filled/24/ffffff/undo--v1.png"/></a>
        <a href=""><img src="https://img.icons8.com/fluent-systems-filled/24/ffffff/redo.png"/></a>
        <li class="saperator"></li>
        <a href=""><img src="https://img.icons8.com/fluent-systems-filled/24/ffffff/share-3.png"/></a>
        <li class="saperator"></li>
        <a href="#"><img src="https://img.icons8.com/fluent-systems-filled/24/ffffff/save.png"/></a>
        
      </div>
    </div>
    <a href=""><img src="https://img.icons8.com/fluent-systems-filled/24/ffffff/image.png"/></a>
    <a href="#"><img src="https://img.icons8.com/fluent-systems-filled/24/ffffff/text-color.png"/></a>
    <a href="#"><img src="https://img.icons8.com/fluent-systems-filled/24/ffffff/color-palette.png"/></a>
    <a href=""><img src="https://img.icons8.com/fluent-systems-filled/24/ffffff/help.png"/></a>     
  </div>
  <div id="content contenteditable=true">
    <canvas id="c" class="refs"></canvas>
  </div>


  <script>  
    var MAX_WIDTH = 800;
    var MAX_HEGIHT = 1000;
    var STR_RGB = "#6ae2ff";

    (function() {

      var deleteImg = document.createElement('img');
      deleteImg.src = "images/trash-alt-regular.svg";

      var cloneImg = document.createElement('img');
      cloneImg.src = "images/copy-regular.svg";

      var fillImg = document.createElement('img');
      fillImg.src = "images/fill-drip-solid.svg";

      // fabric.Itext.prototype.controls.deleteCtrl = new fabric.Control({
      //   x: -0.5,
      //   y: 0.5,
      //   offsetY: 16,
      //   offsetX: -16,
      //   cursorStyle: 'pointer',
      //   mouseUpHandler: fnDeleteObject,
      //   render: fnRenderIcon(deleteImg),
      //   cornerSize: 24
      // });

      fabric.Object.prototype.controls.deleteCtrl = new fabric.Control({
        x: -0.5,
        y: 0.5,
        offsetY: 16,
        offsetX: -16,
        cursorStyle: 'pointer',
        mouseUpHandler: fnDeleteObject,
        render: fnRenderIcon(deleteImg),
        cornerSize: 24
      });

      fabric.Object.prototype.controls.cloneCtrl = new fabric.Control({
        x: 0.5,
        y: 0.5,
        offsetY: 16,
        offsetX: 16,
        cursorStyle: 'pointer',
        mouseUpHandler: fnCloneObject,
        render: fnRenderIcon(cloneImg),
        cornerSize: 24
      });  
      
      fabric.Object.prototype.controls.fillColorCtrl = new fabric.Control({
        x: 0.5,
        y: -0.5,
        offsetY: -16,
        offsetX: 16,
        cursorStyle: 'pointer',
        mouseUpHandler: fnFillColor,
        render: fnRenderIcon(fillImg),
        cornerSize: 24
      });        

      fabric.Object.prototype.transparentCorners = false;
      fabric.Object.prototype.cornerColor = 'blue';
      fabric.Object.prototype.cornerStyle = 'circle';
      
      var $wrapper = $('#content'),
        canvas = new fabric.Canvas('c', {
          selection: false,
          fireRightClick: true,
          stopContextMenu: true,
          width: MAX_WIDTH,
          height: MAX_HEGIHT
        }),

        /*-----------------------------------------------------------*/
        // 클립보드 이미지 붙여 넣기
        /*-----------------------------------------------------------*/
        fnPasteImage = function(e) {
          // alert();
          var items = e.originalEvent.clipboardData.items;
          
          e.preventDefault();
          e.stopPropagation();
          
          //Loop through files
          for (var i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') == -1) continue;
            var file = items[i],
              type = items[i].type;
            var imageData = file.getAsFile();
            var URLobj = window.URL || window.webkitURL;
            var img = new Image();
            img.src = URLobj.createObjectURL(imageData);
            fabric.Image.fromURL(img.src, function(img) {
              canvas.add(img);
            });
          }
        },

        /*-----------------------------------------------------------*/
        // 문자열 추가
        /*-----------------------------------------------------------*/
        fnAddText = function(e) {
          var rect = new fabric.Textbox('This is TextBox', {
            left: 100,
            top: 50,
            width: 200,
            height: 100,
            fontSize: 20,
            objectCaching: false,
            //hasControls: false,
          });

          canvas.add(rect);
          canvas.setActiveObject(rect);
        },        

        /*-----------------------------------------------------------*/
        // 컬러 가이드 추가
        /*-----------------------------------------------------------*/
        fnAddColorGuide = function(e) {
          var rect = new fabric.Rect({
            left: 100,
            top: 50,
            fill: STR_RGB,
            width: 200,
            height: 100,
            objectCaching: false,
            //stroke: 'lightgreen',
            //strokeWidth: 4,
          });

          canvas.add(rect);
          canvas.setActiveObject(rect);
        },

        //Canvas starter text
        fnIntroCanvas = function() {
          // GRID
          var grid = 50;
          // create grid

          for (var i = 0; i < (MAX_HEGIHT / grid); i++) {
            canvas.add(new fabric.Line([i * grid, 0, i * grid, MAX_HEGIHT], {
              stroke: '#d6d6d6',
              selectable: false
            }));
            canvas.add(new fabric.Line([0, i * grid, MAX_WIDTH, i * grid], {
              stroke: '#d6d6d6',
              selectable: false
            }))
          }

          canvas.on({
            'object:moving': function(options) {
              if (Math.round(options.target.left / grid * 4) % 4 == 0 &&
              Math.round(options.target.top / grid * 4) % 4 == 0) {
              options.target.set({
                left: Math.round(options.target.left / grid) * grid,
                top: Math.round(options.target.top / grid) * grid
              }).setCoords();
              }  
            },
            'touch:longpress': function() {
              alert();
            }
          });

          // canvas.on('object:moving', function(options) {
          //   if (Math.round(options.target.left / grid * 4) % 4 == 0 &&
          //     Math.round(options.target.top / grid * 4) % 4 == 0) {
          //     options.target.set({
          //       left: Math.round(options.target.left / grid) * grid,
          //       top: Math.round(options.target.top / grid) * grid
          //     }).setCoords();
          //   }
          // });
          
          // canvas.add(introTxt);                
        };

        /*-----------------------------------------------------------*/
        // 컨트롤
        /*-----------------------------------------------------------*/
        function fnRenderIcon(icon) {
          return function renderIcon(ctx, left, top, styleOverride, fabricObject) {
            var size = this.cornerSize;
            ctx.save();
            ctx.translate(left, top);
            ctx.rotate(fabric.util.degreesToRadians(fabricObject.angle));
            ctx.drawImage(icon, -size/2, -size/2, size, size);
            ctx.restore();
          }
        }

        // 삭제
        function fnDeleteObject(eventData, target) {
          var canvas = target.canvas;
              canvas.remove(target);
              canvas.requestRenderAll();
        }

        // 복사
        function fnCloneObject(eventData, target) {
          var canvas = target.canvas;
          target.clone(function(cloned) {
            cloned.left += 10;
            cloned.top += 10;
            canvas.add(cloned);
          });
        }

        function fnFillColor(eventData, target) {
          var canvas = target.canvas;

        // function $(selector) { return document.querySelector(selector); }
        // const parentFixed = $('#fixed'),
          pickerFixed = new Picker({
            parent: document.querySelector('#fixed'),
            popup: false,
            alpha: false,
            editor: true,
            color: target.fill,
            // onChange: function(color) {
            //   STR_RGB = color.hex;

            //   //console.log("fnFillColor=>" + STR_RGB);
            //   //colorPicker.hide();
            //   target.fill = STR_RGB;
            //   canvas.requestRenderAll(); // 다시 그리기
            // },
            onDone: function(color) {
              STR_RGB = color.hex;
              target.fill = STR_RGB;
              canvas.requestRenderAll(); // 다시 그리기
              this.hide();
            },
          });

          //colorPicker.show();
        }

        // 배경 그리드
        fnIntroCanvas();

        // 붙여넣기 이벤트
        $(window).on('paste', fnPasteImage);

        $(window).keydown(function(e) {	  
          console.log(e.which);
          if (e.which === 89 && e.ctrlKey) {
            // control + y
            //replay(redo, undo, '#undo', this);
          } else if (e.which === 90 && e.ctrlKey) {
            // control + z
            //replay(undo, redo, '#redo', this);
          } else if (e.which === 67 && e.ctrlKey) {
            // control + c
            // Copy();
            console.log("Copy");
          } else if (e.which === 86 && e.ctrlKey) {
            // control + v
            // Paste();
            console.log("Paste");
          }
        });

        
        // 문자열 추가
        $("#btn_text").click(function(){
          fnAddText();
        });

        // 컬러가이드 추가
        $("#btn_color").click(function(){
          fnAddColorGuide();
        });

        // 이미지로 저장하기
        $("#btn_save").click(function(){
          $("#c").get(0).toBlob(function(blob) {
            saveAs(blob, "myImg.png");
          });
        });  

        // $("#btn_paste").click(function(){
        //   alert("준비중");
        //   fnPasteImage();
        // });
        
      })();  

   
  </script>  
  
</body>
</html>