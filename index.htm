<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<head>

  <!-- https://fontawesome.com/icons -->
  <script src="https://kit.fontawesome.com/42f43a2f20.js" crossorigin="anonymous"></script>
  
  <!-- 라이브러리 -->
  <script src="js/fabric.min.js"></script>
  <script src="js/jquery-3.5.1.min.js"></script>
  <script src="js/FileSaver.min.js"></script>
  <script src="js/canvas-toBlob.js"></script>
  <script src="js/vanilla-picker.min.js"></script>

  <style>
    body {
      display: flex;
      flex-flow: column;
      align-items: center;
      height: 97vh;
      background: #fff;
    }

    #content {
      flex: 1;
      margin: 1em auto auto;
    }

    .refs {
      border-right: solid 1px #d6d6d6;
      border-bottom: solid 1px #d6d6d6;
      /* border-radius: 7px; */
    }

    nav {
      display: flex;
      justify-content: space-around;
      width: 50%;
    }

    button {
      color: #222;
      background: none;
      border: none;
      border-radius: 5px;
      padding: 0.5em;
    }

    button:hover {
      color: #d6d6d6;
      background: #222;
    }

    .highlight {
      border: 2px #6fb5f1 solid;
      box-shadow: 0 0 10px 2px #6fb5f1;
      transition: border 150ms linear, box-shadow 150ms linear;
    }   

    .fas {
      color: #615f62;
    }
  </style>
</head>

<body>
  <!--canvas id="c" width="800" height="600"></canvas>
  <input id="b" type="button" value="이미지로 저장"/ -->
  <table>
    <tr>
      <td>
        <div id="content contenteditable=true">
          <canvas id="c" class="refs"></canvas>
        </div>
        <nav>
          <button type="button" id="btn_text">
            <!--i class="fas fa-paste"> 붙여넣기</i -->
            <i class="fas fa-align-left"> 문자열</i>
          </button>
          <button type="button" id="btn_color">
            <i class="fas fa-plus-circle"> 컬러가이드</i>
          </button>        
          <button type="button" id="btn_save">
            <i class="fas fa-save"> 저장</i>
          </button>
        </nav>
      </td>
      <td width="300"><div id="fixed"></div></td>
    </tr>    
  </table>

  <script>  
    var MAX_WIDTH = 800;
    var MAX_HEGIHT = 1000;
    var STR_RGB = "#6ae2ff";

    (function() {

      var deleteImg = document.createElement('img');
      deleteImg.src = "images/trash-alt-regular.svg";

      var cloneImg = document.createElement('img');
      cloneImg.src = "images/copy-regular.svg";

      var fillImg = document.createElement('img');
      fillImg.src = "images/fill-drip-solid.svg";

      // fabric.Itext.prototype.controls.deleteCtrl = new fabric.Control({
      //   x: -0.5,
      //   y: 0.5,
      //   offsetY: 16,
      //   offsetX: -16,
      //   cursorStyle: 'pointer',
      //   mouseUpHandler: fnDeleteObject,
      //   render: fnRenderIcon(deleteImg),
      //   cornerSize: 24
      // });

      fabric.Object.prototype.controls.deleteCtrl = new fabric.Control({
        x: -0.5,
        y: 0.5,
        offsetY: 16,
        offsetX: -16,
        cursorStyle: 'pointer',
        mouseUpHandler: fnDeleteObject,
        render: fnRenderIcon(deleteImg),
        cornerSize: 24
      });

      fabric.Object.prototype.controls.cloneCtrl = new fabric.Control({
        x: 0.5,
        y: 0.5,
        offsetY: 16,
        offsetX: 16,
        cursorStyle: 'pointer',
        mouseUpHandler: fnCloneObject,
        render: fnRenderIcon(cloneImg),
        cornerSize: 24
      });  
      
      fabric.Object.prototype.controls.fillColorCtrl = new fabric.Control({
        x: 0.5,
        y: -0.5,
        offsetY: -16,
        offsetX: 16,
        cursorStyle: 'pointer',
        mouseUpHandler: fnFillColor,
        render: fnRenderIcon(fillImg),
        cornerSize: 24
      });        

      fabric.Object.prototype.transparentCorners = false;
      fabric.Object.prototype.cornerColor = 'blue';
      fabric.Object.prototype.cornerStyle = 'circle';
      
      var $wrapper = $('#content'),
        canvas = new fabric.Canvas('c', {
          selection: false,
          fireRightClick: true,
          stopContextMenu: true,
          width: MAX_WIDTH,
          height: MAX_HEGIHT
        }),

        /*-----------------------------------------------------------*/
        // 클립보드 이미지 붙여 넣기
        /*-----------------------------------------------------------*/
        fnPasteImage = function(e) {
          // alert();
          var items = e.originalEvent.clipboardData.items;
          
          e.preventDefault();
          e.stopPropagation();
          
          //Loop through files
          for (var i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') == -1) continue;
            var file = items[i],
              type = items[i].type;
            var imageData = file.getAsFile();
            var URLobj = window.URL || window.webkitURL;
            var img = new Image();
            img.src = URLobj.createObjectURL(imageData);
            fabric.Image.fromURL(img.src, function(img) {
              canvas.add(img);
            });
          }
        },

        /*-----------------------------------------------------------*/
        // 문자열 추가
        /*-----------------------------------------------------------*/
        fnAddText = function(e) {
          var rect = new fabric.Textbox('This is TextBox', {
            left: 100,
            top: 50,
            width: 200,
            height: 100,
            fontSize: 20,
            objectCaching: false,
            //hasControls: false,
          });

          canvas.add(rect);
          canvas.setActiveObject(rect);
        },        

        /*-----------------------------------------------------------*/
        // 컬러 가이드 추가
        /*-----------------------------------------------------------*/
        fnAddColorGuide = function(e) {
          var rect = new fabric.Rect({
            left: 100,
            top: 50,
            fill: STR_RGB,
            width: 200,
            height: 100,
            objectCaching: false,
            //stroke: 'lightgreen',
            //strokeWidth: 4,
          });

          canvas.add(rect);
          canvas.setActiveObject(rect);
        },

        //Canvas starter text
        fnIntroCanvas = function() {
          // GRID
          var grid = 50;
          // create grid

          for (var i = 0; i < (MAX_HEGIHT / grid); i++) {
            canvas.add(new fabric.Line([i * grid, 0, i * grid, MAX_HEGIHT], {
              stroke: '#d6d6d6',
              selectable: false
            }));
            canvas.add(new fabric.Line([0, i * grid, MAX_WIDTH, i * grid], {
              stroke: '#d6d6d6',
              selectable: false
            }))
          }

          canvas.on({
            'object:moving': function(options) {
              if (Math.round(options.target.left / grid * 4) % 4 == 0 &&
              Math.round(options.target.top / grid * 4) % 4 == 0) {
              options.target.set({
                left: Math.round(options.target.left / grid) * grid,
                top: Math.round(options.target.top / grid) * grid
              }).setCoords();
              }  
            },
            'touch:longpress': function() {
              alert();
            }
          });

          // canvas.on('object:moving', function(options) {
          //   if (Math.round(options.target.left / grid * 4) % 4 == 0 &&
          //     Math.round(options.target.top / grid * 4) % 4 == 0) {
          //     options.target.set({
          //       left: Math.round(options.target.left / grid) * grid,
          //       top: Math.round(options.target.top / grid) * grid
          //     }).setCoords();
          //   }
          // });
          
          // canvas.add(introTxt);                
        };

        /*-----------------------------------------------------------*/
        // 컨트롤
        /*-----------------------------------------------------------*/
        function fnRenderIcon(icon) {
          return function renderIcon(ctx, left, top, styleOverride, fabricObject) {
            var size = this.cornerSize;
            ctx.save();
            ctx.translate(left, top);
            ctx.rotate(fabric.util.degreesToRadians(fabricObject.angle));
            ctx.drawImage(icon, -size/2, -size/2, size, size);
            ctx.restore();
          }
        }

        // 삭제
        function fnDeleteObject(eventData, target) {
          var canvas = target.canvas;
              canvas.remove(target);
              canvas.requestRenderAll();
        }

        // 복사
        function fnCloneObject(eventData, target) {
          var canvas = target.canvas;
          target.clone(function(cloned) {
            cloned.left += 10;
            cloned.top += 10;
            canvas.add(cloned);
          });
        }

        function fnFillColor(eventData, target) {
          var canvas = target.canvas;

        // function $(selector) { return document.querySelector(selector); }
        // const parentFixed = $('#fixed'),
          pickerFixed = new Picker({
            parent: document.querySelector('#fixed'),
            popup: false,
            alpha: false,
            editor: true,
            color: target.fill,
            // onChange: function(color) {
            //   STR_RGB = color.hex;

            //   //console.log("fnFillColor=>" + STR_RGB);
            //   //colorPicker.hide();
            //   target.fill = STR_RGB;
            //   canvas.requestRenderAll(); // 다시 그리기
            // },
            onDone: function(color) {
              STR_RGB = color.hex;
              target.fill = STR_RGB;
              canvas.requestRenderAll(); // 다시 그리기
              this.hide();
            },
          });

          //colorPicker.show();
        }

        // 배경 그리드
        fnIntroCanvas();

        // 붙여넣기 이벤트
        $(window).on('paste', fnPasteImage);

        $(window).keydown(function(e) {	  
          console.log(e.which);
          if (e.which === 89 && e.ctrlKey) {
            // control + y
            //replay(redo, undo, '#undo', this);
          } else if (e.which === 90 && e.ctrlKey) {
            // control + z
            //replay(undo, redo, '#redo', this);
          } else if (e.which === 67 && e.ctrlKey) {
            // control + c
            // Copy();
            console.log("Copy");
          } else if (e.which === 86 && e.ctrlKey) {
            // control + v
            // Paste();
            console.log("Paste");
          }
        });

        
        // 문자열 추가
        $("#btn_text").click(function(){
          fnAddText();
        });

        // 컬러가이드 추가
        $("#btn_color").click(function(){
          fnAddColorGuide();
        });

        // 이미지로 저장하기
        $("#btn_save").click(function(){
          $("#c").get(0).toBlob(function(blob) {
            saveAs(blob, "myImg.png");
          });
        });  

        // $("#btn_paste").click(function(){
        //   alert("준비중");
        //   fnPasteImage();
        // });
        
      })();  

   
  </script>

</body>  
</html>  