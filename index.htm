<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">
<head>
  <link rel="stylesheet" href="js/sweetalert2.min.css" id="theme-styles">

  <!-- 라이브러리 -->
  <script src="js/fabric.min.js"></script>         <!-- [MIT License] Javascript Canvas Library, SVG-to-Canvas (& canvas-to-SVG) Parser (https://github.com/fabricjs/fabric.js) -->
  <script src="js/index.min.js"></script>          <!-- [MIT License] Fabric.js history plugin (https://github.com/lyzerk/fabric-history) -->
  <script src="js/jquery-3.5.1.min.js"></script>   <!-- [MIT License] jQuery JavaScript Library (https://github.com/jquery/jquery) -->
  <script src="js/FileSaver.min.js"></script>      <!-- [MIT License] An HTML5 saveAs() FileSaver implementation (https://github.com/eligrey/FileSaver.js)-->
  <script src="js/canvas-toBlob.js"></script>      <!-- [MIT License] A canvas.toBlob() implementation (https://github.com/eligrey/canvas-toBlob.js) -->
  <script src="js/vanilla-picker.min.js"></script> <!-- [ISC License] About A simple, easy to use vanilla JS color picker with alpha selection. (https://github.com/Sphinxxxx/vanilla-picker) -->
  <script src="js/sweetalert2.min.js"></script>    <!-- [MIT License] A beautiful, responsive, highly customizable and accessible (WAI-ARIA) replacement for JavaScript's popup boxes. Zero dependencies. (https://github.com/sweetalert2/sweetalert2) -->
  <!-- 커스텀 -->
  <script src="js/smud.js"></script>

  <style>
    @import url(http://fonts.googleapis.com/earlyaccess/notosanskr.css); /* Noto Sans KR 웹폰트 */

    body {
      font-family: "Noto Sans KR", sans-serif;
      margin: 0px;        
    }

    /* 메뉴 */
    .navbar {
      overflow: hidden;
      /* height: 38px; */
      color: #000000;
      background-color: #E9FF2E;
    }
    
    .logo {
      float: left;
      margin-left: 10px;
      height: 48px;
    }

    .fab-container {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 999;
        cursor: pointer;
    }

    /* 셋팅 */
    .fab-icon-holder {
        width: 24px;
        height: 24px;
    }

    .fab-icon-holder:hover {
        opacity: 0.8;
    }

    .fab-icon-holder img {
        display: flex;
        align-items: center;
        justify-content: center;

        height: 100%;
        font-size: 25px;
        color: #ffffff;
    }

    .fab {
        width: 24px;
        height: 24px;
    }

    .fab-options {
        list-style-type: none;
        margin: 0;

        position: absolute;
        top: 30px;
        right: 0;

        opacity: 0;

        transition: all 0.3s ease;
        transform: scale(0);
        transform-origin: 85% top;
    }

    .fab:hover+.fab-options,
    .fab-options:hover {
        opacity: 1;
        transform: scale(1);
    }

    .fab-options li {
        display: flex;
        justify-content: flex-end;
        padding: 5px 0px 5px 5px;
    }

    .fab-label {
        padding: 2px 5px;
        align-self: center;
        user-select: none;
        white-space: nowrap;
        border-radius: 3px;
        font-size: 16px;
        background: #666666;
        color: #ffffff;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        margin-right: 10px;
    }

    .panel .color {
      /* position: fixed;
      top: 20px;
      right : 200px; */
      width: 0px;
      height: 0px;      
      /* cursor: pointer;      
      float: left;      
      margin: 3px;
      border: black 2px solid; */
      background-color: #000000;
    }

    /* 정보 */
    .info {
      text-align: left;
    }

    /* 마인드 영역 */
    #content {
      overflow: hidden;
      height: calc(100% - 52px);
    }


</style>
</head>

<body>
  <div class="navbar">
    <img class="logo" src="images/smud_logo.svg">
    <div class="fab-container">
      <div class="fab fab-icon-holder">
        <img src="https://img.icons8.com/fluent-systems-filled/24/000000/settings.png"/>
      </div>
      <ul class="fab-options">
        <li>
          <span class="fab-label">도움말</span>
          <div class="fab-icon-holder">
            <img id="menu_help" src="https://img.icons8.com/fluent-systems-filled/48/000000/help.png" alt="도움말"/>
          </div>
        </li>
      </ul>
    </div>    
    <div class="panel"><div class="color"></div></div>
  </div>  


  <div id="content">
    <canvas id="c"></canvas>
  </div>

  <script> 
    (function() {

      fabric.Object.prototype.transparentCorners = false;
      fabric.Object.prototype.cornerColor = 'blue';
      fabric.Object.prototype.cornerStyle = 'circle';
      
      var $wrapper = $('#content'),
        canvas = new fabric.Canvas('c', {
          selection: false,
          fireRightClick: true,
          stopContextMenu: true,
          width: $("#content").width(), //window.innerWidth,
          height: $("#content").height(), //window.innerHeight
        });
       
        // 배경 그리드
        canvas.initCanvas();       

        /*-----------------------------------------------------------*/
        // 이벤트 처리
        /*-----------------------------------------------------------*/  
        $(window).resize(function () {
          if (canvas.width != $("#content").width()) {
              canvas.setWidth($("#content").width());
              canvas.setHeight($("#content").height());
              canvas.renderAll();
              canvas.calcOffset();

              console.log($("#content").width());
          }
        });

        $(window).on({
          'paste': function(e) {
            canvas.PasteImage(e);
          },
          'drop': function(e) {
            e.preventDefault();

            var files = e.originalEvent.dataTransfer.files;          
            
            for(var i = 0; i < files.length; i++) {
              if (files[i].type.indexOf('image') == -1) continue;
              var file = files[i],
                type = files[i].type;
              //var imageData = file.getAsFile();
              var URLobj = window.URL || window.webkitURL;
              var img = new Image();
              img.src = URLobj.createObjectURL(file);
              fabric.Image.fromURL(img.src, function(img) {
                canvas.add(img);
              });
            }
          },
          'keydown': function(e) {
            // console.log(e.which);
            if (e.which === 89 && e.ctrlKey) { // ctrl + y
              canvas.redo();
            } else if ((e.ctrlKey || e.metaKey) && e.which === 90) { // ctrl + z
              e.preventDefault();
              canvas.undo();
            } else if ((e.ctrlKey || e.metaKey) && e.which === 88) { // ctrl + x
              e.preventDefault();
              canvas.Cut();              
            } else if ((e.ctrlKey || e.metaKey) && e.which === 67) { // ctrl + c
              e.preventDefault();
              canvas.Copy();
            } else if ((e.ctrlKey || e.metaKey) && e.which === 86) { // ctrl + v
              e.preventDefault();              
              canvas.Paste();
            } else if (e.which === 84 && (! canvas.getActiveObject() || canvas.getActiveObject().type !== 'textbox' || ! canvas.getActiveObject().isEditing)) { // t 텍스트박스
              canvas.AddTextBox();
            } else if (e.which === 77 && (! canvas.getActiveObject() || canvas.getActiveObject().type !== 'textbox' || ! canvas.getActiveObject().isEditing)) { // m 사각형
              canvas.AddRect();
            } else if (e.which === 76 && (! canvas.getActiveObject() || canvas.getActiveObject().type !== 'textbox' || ! canvas.getActiveObject().isEditing)) { // l 동그라미
              canvas.AddCircle();
            } else if (e.which === 32) { // space bar
              canvas.SpaceBarKeyDn();
            } else if (e.which === 46) { // delete
              canvas.Delete();              
            } else if ((e.ctrlKey || e.metaKey) && e.which === 83) { // ctrl + s
              e.preventDefault();
              $("#c").get(0).toBlob(function(blob) {
                saveAs(blob, "mind.png");
              });            
            }
          },
          'keyup': function(e) {
            if  (e.which === 32) { // space bar
              canvas.SpaceBarKeyUp();
            }
          }
        });

        /*-----------------------------------------------------------*/
        // 메뉴 기능
        /*-----------------------------------------------------------*/     
        // 붙여 넣기

        
        // // 문자열 추가
        // $("#menu_addText").click(function(){
        //   //fnAddText();
        //   canvas.AddTextBox();
        // });

        // // 컬러가이드 추가
        // $("#menu_addRect").click(function(){
        //   canvas.AddRect();
        // });

        // // 이미지로 저장하기
        // $("#menu_saveImage").click(function(){
        //   $("#c").get(0).toBlob(function(blob) {
        //     saveAs(blob, "mind.png");
        //   });
        // });

        // // 실행 취소
        // $("#menu_undo").click(function(){
        //   canvas.undo();
        // });

        // // 다시 실행
        // $("#menu_redo").click(function(){
        //   canvas.redo();
        // });

        // // 잘라내기
        // $("#menu_cut").click(function(){
        //   canvas.Cut();
        // });

        // // 복사
        // $("#menu_copy").click(function(){
        //   canvas.Copy();
        // });
        
        // // 붙여넣기
        // $("#menu_paste").click(function(){
        //   canvas.Paste();
        // });

        // // 삭제
        // $("#menu_delete").click(function(){
        //   canvas.Delete();
        // });

        // $(".panel .color").click(function(){
        //   canvas.FillColor();
        // })

        // 도움말
        $("#menu_help").click(function(){
          Swal.fire({
              title: 'SMUD V0.3 도움말',
              // icon: 'info',
              html:
                '<div class="info">' +
                '<li>T : 텍스트박스 추가</li>' +
                '<li>M : 사각형 추가</li>' +
                '<li>L : 타원 추가</li>' +
                '<li>SHIFT + 선택 : 그룹</li>' +
                '<li>DRAG & DROP : 이미지 추가</li>' +                
                '<li>SPACE + DRAG : 마인드 시점 이동</li>' +
                '<li>마우스 휠 : 마인드 확대/축소</li>' +
                '<li>CTRL + Z : 실행 취소</li>' +
                '<li>CTRL + Y : 다시 실행</li>' +
                '<li>CTRL + X : 잘라내기</li>' +
                '<li>CTRL + C : 복사</li>' +
                '<li>CTRL + V : 붙여넣기</li>' +
                '<li>DELETE : 삭제</li>' +
                '<li>CTRL + S : 이미지로 저장</li>' +
                '</div>',
            });
        });
          
      })();
   
  </script>  
  
</body>
</html>